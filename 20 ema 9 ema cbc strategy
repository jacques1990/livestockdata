//@version=5
strategy("EMA Angle System - DT / LB / LS / EX", overlay=true)

// Inputs
emaFastLen    = input.int(9,  "EMA 9")
emaSlowLen    = input.int(20, "EMA 20")
slopeLookback = input.int(6,  "Slope Lookback")
atrLen        = input.int(14, "ATR Length")
minSlopeATR   = input.float(0.05, "Min Slope (ATR)", step=0.01)
cooldownBars  = input.int(8, "Cooldown After Cross", minval=0)

// Calculations
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
atr     = ta.atr(atrLen)

slopeFast = (emaFast - emaFast[slopeLookback]) / atr
slopeSlow = (emaSlow - emaSlow[slopeLookback]) / atr

angledUp   = slopeFast >  minSlopeATR and slopeSlow >  minSlopeATR
angledDown = slopeFast < -minSlopeATR and slopeSlow < -minSlopeATR
flatEMAs   = not angledUp and not angledDown

emaCross = ta.cross(emaFast, emaSlow)

var int lastCrossBar = na
if emaCross
    lastCrossBar := bar_index

inCooldown = cooldownBars > 0 and not na(lastCrossBar) and (bar_index - lastCrossBar) <= cooldownBars

dontTrade = flatEMAs or emaCross or inCooldown

// Candle direction
isGreen = close > open
isRed   = close < open

// Trend direction
trendUp   = emaFast > emaSlow
trendDown = emaFast < emaSlow

// Signals
longSignal  = (not dontTrade) and angledUp and trendUp and isGreen   // LB
shortSignal = (not dontTrade) and angledDown and trendDown and isRed // LS

// EX signals (momentum interruption candle in a trend)
exLong  = (not dontTrade) and angledUp and trendUp and isRed         // bullish trend + red candle
exShort = (not dontTrade) and angledDown and trendDown and isGreen   // bearish trend + green candle
exSignal = exLong or exShort

// Orders (optional; labels will show regardless)
if longSignal
    strategy.entry("LONG", strategy.long)

if shortSignal
    strategy.entry("SHORT", strategy.short)

// Plot EMAs
plot(emaFast, "EMA 9",  color=color.white, linewidth=2)
plot(emaSlow, "EMA 20", color=color.blue,  linewidth=2)

// Labels
if dontTrade
    label.new(bar_index, high, "DT", style=label.style_label_down, color=color.gray, textcolor=color.white, size=size.tiny)

if longSignal
    label.new(bar_index, low, "LB", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)

if shortSignal
    label.new(bar_index, high, "LS", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)

// EX label: put it above bar for long-exit, below bar for short-exit (so you can tell which one)
if exLong
    label.new(bar_index, high, "EX", style=label.style_label_down, color=color.orange, textcolor=color.white, size=size.tiny)

if exShort
    label.new(bar_index, low, "EX", style=label.style_label_up, color=color.orange, textcolor=color.white, size=size.tiny)

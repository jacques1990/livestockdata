//@version=5
strategy("EMA Angle System - LIVE Repaint (DT/LB/LS/EX)", overlay=true, calc_on_every_tick=true)

// ===== Inputs
emaFastLen    = input.int(9,  "EMA 9")
emaSlowLen    = input.int(20, "EMA 20")
slopeLookback = input.int(6,  "Slope Lookback")
atrLen        = input.int(14, "ATR Length")
minSlopeATR   = input.float(0.05, "Min Slope (ATR)", step=0.01)
cooldownBars  = input.int(8, "Cooldown After Cross", minval=0)

// ===== Calcs
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
atr     = ta.atr(atrLen)

slopeFast = (emaFast - emaFast[slopeLookback]) / atr
slopeSlow = (emaSlow - emaSlow[slopeLookback]) / atr

angledUp   = slopeFast >  minSlopeATR and slopeSlow >  minSlopeATR
angledDown = slopeFast < -minSlopeATR and slopeSlow < -minSlopeATR
flatEMAs   = not angledUp and not angledDown

emaCross = ta.cross(emaFast, emaSlow)

var int lastCrossBar = na
if emaCross
    lastCrossBar := bar_index

inCooldown = cooldownBars > 0 and not na(lastCrossBar) and (bar_index - lastCrossBar) <= cooldownBars
dontTrade  = flatEMAs or emaCross or inCooldown

isGreen = close > open
isRed   = close < open

trendUp   = emaFast > emaSlow
trendDown = emaFast < emaSlow

// ===== Signals (LIVE / can repaint intrabar)
longSignal  = (not dontTrade) and angledUp and trendUp and isGreen   // LB
shortSignal = (not dontTrade) and angledDown and trendDown and isRed // LS

exLong  = (not dontTrade) and angledUp and trendUp and isRed         // bullish trend + red candle
exShort = (not dontTrade) and angledDown and trendDown and isGreen   // bearish trend + green candle
exSignal = exLong or exShort

// ===== Plots
plot(emaFast, "EMA 9",  color=color.white, linewidth=2)
plot(emaSlow, "EMA 20", color=color.blue,  linewidth=2)

// ===== LIVE label objects (one each)
var label dtLbl = na
var label lbLbl = na
var label lsLbl = na
var label exLbl = na

// Only manage live labels in realtime (current forming candle)
if barstate.isrealtime

    // --- DT label ---
    if dontTrade
        if na(dtLbl)
            dtLbl := label.new(bar_index, high, "DT", style=label.style_label_down, color=color.gray, textcolor=color.white, size=size.tiny)
        else
            label.set_x(dtLbl, bar_index), label.set_y(dtLbl, high), label.set_text(dtLbl, "DT")
    else
        if not na(dtLbl)
            label.delete(dtLbl), dtLbl := na

    // --- LB label ---
    if longSignal
        if na(lbLbl)
            lbLbl := label.new(bar_index, low, "LB", style=label.style_label_up, color=color.green, textcolor=color.white, size=size.small)
        else
            label.set_x(lbLbl, bar_index), label.set_y(lbLbl, low), label.set_text(lbLbl, "LB")
    else
        if not na(lbLbl)
            label.delete(lbLbl), lbLbl := na

    // --- LS label ---
    if shortSignal
        if na(lsLbl)
            lsLbl := label.new(bar_index, high, "LS", style=label.style_label_down, color=color.red, textcolor=color.white, size=size.small)
        else
            label.set_x(lsLbl, bar_index), label.set_y(lsLbl, high), label.set_text(lsLbl, "LS")
    else
        if not na(lsLbl)
            label.delete(lsLbl), lsLbl := na

    // --- EX label (location depends on which EX) ---
    exY   = exLong ? high : low
    exSty = exLong ? label.style_label_down : label.style_label_up

    if exSignal
        if na(exLbl)
            exLbl := label.new(bar_index, exY, "EX", style=exSty, color=color.orange, textcolor=color.white, size=size.tiny)
        else
            label.set_x(exLbl, bar_index), label.set_y(exLbl, exY), label.set_style(exLbl, exSty), label.set_text(exLbl, "EX")
    else
        if not na(exLbl)
            label.delete(exLbl), exLbl := na

//@version=5
indicator("S/R Zones + LIVE Breakout/Rejection Signals", overlay=true, max_lines_count=500, max_boxes_count=500)

// =====================
// Inputs
// =====================
lookback      = input.int(200, "Max stored pivots", minval=50, maxval=2000)
pivotStrength = input.int(3, "Pivot Strength", minval=1, maxval=15)
numLevels     = input.int(3, "Draw levels (recent)", minval=1, maxval=10)
zonePercent   = input.float(0.30, "Zone Width %", minval=0.05, maxval=3.0)
extendRight   = input.int(50, "Extend right bars", minval=10, maxval=300)

// Signal mode
liveMode      = input.bool(true, "LIVE signals (repaint intrabar)")
confirmBars   = input.int(1, "Confirm bars (0=now, 1=2nd candle, 2=3rd candle)", minval=0, maxval=3)

// Candle thresholds (used for CONFIRMED signals)
minBodyPct    = input.float(0.55, "Min body % of range (confirmed only)", minval=0.10, maxval=0.95)
maxSmallWick  = input.float(0.25, "Max wick % (confirmed only)", minval=0.05, maxval=0.70)
minLongWick   = input.float(0.45, "Min wick % (rejection, confirmed only)", minval=0.10, maxval=0.95)

// Optional filter
useEMAFilter  = input.bool(true, "Filter with EMA trend")
emaFastLen    = input.int(14, "EMA Fast", minval=2, maxval=200)
emaSlowLen    = input.int(20, "EMA Slow", minval=2, maxval=300)

// Colors
resZoneColor  = input.color(color.new(color.red, 85), "Resistance Zone")
supZoneColor  = input.color(color.new(color.green, 85), "Support Zone")
resLineColor  = input.color(color.red, "Resistance Line")
supLineColor  = input.color(color.green, "Support Line")

// =====================
// Store pivot highs/lows
// =====================
var float[] resArr = array.new_float()
var float[] supArr = array.new_float()

ph = ta.pivothigh(high, pivotStrength, pivotStrength)
pl = ta.pivotlow(low, pivotStrength, pivotStrength)

if not na(ph)
    array.push(resArr, ph)
if not na(pl)
    array.push(supArr, pl)

if array.size(resArr) > lookback
    array.shift(resArr)
if array.size(supArr) > lookback
    array.shift(supArr)

// =====================
// Nearest R above / S below (for signals)
// =====================
float rLevel = na
float sLevel = na

if array.size(resArr) > 0
    for i = 0 to array.size(resArr) - 1
        lvl = array.get(resArr, i)
        if lvl > close
            rLevel := na(rLevel) ? lvl : math.min(rLevel, lvl)

if array.size(supArr) > 0
    for i = 0 to array.size(supArr) - 1
        lvl = array.get(supArr, i)
        if lvl < close
            sLevel := na(sLevel) ? lvl : math.max(sLevel, lvl)

rZone = not na(rLevel) ? rLevel * (zonePercent / 100) : na
sZone = not na(sLevel) ? sLevel * (zonePercent / 100) : na

// =====================
// EMA filter
// =====================
emaFast = ta.ema(close, emaFastLen)
emaSlow = ta.ema(close, emaSlowLen)
emaBull = emaFast > emaSlow and close > emaFast
emaBear = emaFast < emaSlow and close < emaFast
passBull = (not useEMAFilter) or emaBull
passBear = (not useEMAFilter) or emaBear

plot(useEMAFilter ? emaFast : na, "EMA Fast", color=color.new(color.yellow, 0))
plot(useEMAFilter ? emaSlow : na, "EMA Slow", color=color.new(color.orange, 0))

// =====================
// Candle anatomy (for CONFIRMED only)
// =====================
rng   = high - low
body  = math.abs(close - open)
upper = high - math.max(open, close)
lower = math.min(open, close) - low

bodyPct  = rng > 0 ? body / rng : 0.0
upperPct = rng > 0 ? upper / rng : 0.0
lowerPct = rng > 0 ? lower / rng : 0.0

cleanBull = (bodyPct >= minBodyPct) and (upperPct <= maxSmallWick)
cleanBear = (bodyPct >= minBodyPct) and (lowerPct <= maxSmallWick)
rejRes    = (upperPct >= minLongWick)
rejSup    = (lowerPct >= minLongWick)

// =====================
// Core level tests
// =====================
haveR = not na(rLevel) and not na(rZone)
haveS = not na(sLevel) and not na(sZone)

rBreakLine = haveR ? (rLevel + rZone) : na
sBreakLine = haveS ? (sLevel - sZone) : na

// =====================
// LIVE signals (intrabar)  ✅ can repaint
// =====================
liveBuyBO   = haveR and (high > rBreakLine) and (close > rLevel) and passBull
liveSellBD  = haveS and (low  < sBreakLine) and (close < sLevel) and passBear

liveSellRJ  = haveR and (high >= (rLevel - rZone)) and (close < rLevel) and passBear
liveBuyRJ   = haveS and (low  <= (sLevel + sZone)) and (close > sLevel) and passBull

// =====================
// CONFIRMED signals (after candle close) ✅ best accuracy
// =====================
breakAbove = haveR ? (close > rBreakLine) : false
breakBelow = haveS ? (close < sBreakLine) : false

heldAbove = breakAbove
heldBelow = breakBelow

if confirmBars >= 1
    heldAbove := heldAbove and breakAbove[1]
    heldBelow := heldBelow and breakBelow[1]
if confirmBars >= 2
    heldAbove := heldAbove and breakAbove[2]
    heldBelow := heldBelow and breakBelow[2]
if confirmBars >= 3
    heldAbove := heldAbove and breakAbove[3]
    heldBelow := heldBelow and breakBelow[3]

confBuyBO   = heldAbove and cleanBull and passBull and barstate.isconfirmed
confSellBD  = heldBelow and cleanBear and passBear and barstate.isconfirmed
confSellRJ  = haveR and (high >= (rLevel - rZone)) and rejRes and (close < rLevel) and passBear and barstate.isconfirmed
confBuyRJ   = haveS and (low  <= (sLevel + sZone)) and rejSup and (close > sLevel) and passBull and barstate.isconfirmed

// =====================
// Final signals based on mode
// =====================
buyBO  = liveMode ? liveBuyBO  : confBuyBO
sellBD = liveMode ? liveSellBD : confSellBD
sellRJ = liveMode ? liveSellRJ : confSellRJ
buyRJ  = liveMode ? liveBuyRJ  : confBuyRJ

// =====================
// Plot signals (FIXED: no dynamic text)
// =====================
// BUY Breakout
plotshape(liveMode and buyBO,  title="BUY Breakout LIVE", style=shape.labelup, text="BUY BO(L)",
     location=location.belowbar, size=size.tiny, color=color.new(color.green, 0), textcolor=color.white)
plotshape((not liveMode) and buyBO, title="BUY Breakout CONF", style=shape.labelup, text="BUY BO",
     location=location.belowbar, size=size.tiny, color=color.new(color.green, 0), textcolor=color.white)

// SELL Breakdown
plotshape(liveMode and sellBD, title="SELL Breakdown LIVE", style=shape.labeldown, text="SELL BD(L)",
     location=location.abovebar, size=size.tiny, color=color.new(color.red, 0), textcolor=color.white)
plotshape((not liveMode) and sellBD, title="SELL Breakdown CONF", style=shape.labeldown, text="SELL BD",
     location=location.abovebar, size=size.tiny, color=color.new(color.red, 0), textcolor=color.white)

// BUY Reject
plotshape(liveMode and buyRJ,  title="BUY Reject LIVE", style=shape.triangleup, text="BUY RJ(L)",
     location=location.belowbar, size=size.tiny, color=color.new(color.lime, 0), textcolor=color.black)
plotshape((not liveMode) and buyRJ, title="BUY Reject CONF", style=shape.triangleup, text="BUY RJ",
     location=location.belowbar, size=size.tiny, color=color.new(color.lime, 0), textcolor=color.black)

// SELL Reject
plotshape(liveMode and sellRJ, title="SELL Reject LIVE", style=shape.triangledown, text="SELL RJ(L)",
     location=location.abovebar, size=size.tiny, color=color.new(color.maroon, 0), textcolor=color.white)
plotshape((not liveMode) and sellRJ, title="SELL Reject CONF", style=shape.triangledown, text="SELL RJ",
     location=location.abovebar, size=size.tiny, color=color.new(color.maroon, 0), textcolor=color.white)

// =====================
// Alerts
// =====================
alertcondition(buyBO,  "BUY Breakout",   "BUY Breakout signal")
alertcondition(sellBD, "SELL Breakdown", "SELL Breakdown signal")
alertcondition(buyRJ,  "BUY Rejection",  "BUY Rejection signal")
alertcondition(sellRJ, "SELL Rejection", "SELL Rejection signal")

// =====================
// Draw recent levels (last bar only)
// =====================
var line[] rLines = array.new_line()
var box[]  rBoxes = array.new_box()
var line[] sLines = array.new_line()
var box[]  sBoxes = array.new_box()

if barstate.islast
    if array.size(rLines) > 0
        for i = 0 to array.size(rLines) - 1
            line.delete(array.get(rLines, i))
    if array.size(rBoxes) > 0
        for i = 0 to array.size(rBoxes) - 1
            box.delete(array.get(rBoxes, i))
    if array.size(sLines) > 0
        for i = 0 to array.size(sLines) - 1
            line.delete(array.get(sLines, i))
    if array.size(sBoxes) > 0
        for i = 0 to array.size(sBoxes) - 1
            box.delete(array.get(sBoxes, i))

    array.clear(rLines)
    array.clear(rBoxes)
    array.clear(sLines)
    array.clear(sBoxes)

    if array.size(resArr) > 0
        start = math.max(0, array.size(resArr) - numLevels)
        for i = start to array.size(resArr) - 1
            level = array.get(resArr, i)
            zone  = level * (zonePercent / 100)
            b = box.new(bar_index - lookback, level - zone, bar_index + extendRight, level + zone, border_color=na, bgcolor=resZoneColor)
            l = line.new(bar_index - lookback, level, bar_index + extendRight, level, color=resLineColor, width=2)
            array.push(rBoxes, b)
            array.push(rLines, l)

    if array.size(supArr) > 0
        start2 = math.max(0, array.size(supArr) - numLevels)
        for i = start2 to array.size(supArr) - 1
            level = array.get(supArr, i)
            zone  = level * (zonePercent / 100)
            b = box.new(bar_index - lookback, level - zone, bar_index + extendRight, level + zone, border_color=na, bgcolor=supZoneColor)
            l = line.new(bar_index - lookback, level, bar_index + extendRight, level, color=supLineColor, width=2)
            array.push(sBoxes, b)
            array.push(sLines, l)
